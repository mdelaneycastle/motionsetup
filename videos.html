<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Uploader</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    h1, h2 { color: #333; }
    select, input[type="file"] { margin-bottom: 10px; padding: 6px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Upload a Video</h1>

  <input type="file" id="fileInput" accept="video/*">
  <button onclick="uploadFile()">Upload</button>

  <div id="progressContainer" style="display:none; margin-top: 10px;">
    <progress id="uploadProgress" value="0" max="100" style="width: 100%;"></progress>
    <p id="progressText">0%</p>
    <p id="speedText">Speed: 0 MB/s</p>
  </div>

  <h2>Available Videos</h2>
  <img id="videoPreview" src="" alt="Preview will appear here" style="max-width: 300px; display: block; margin-bottom: 10px;">
  <select id="videoDropdown">
    <option disabled selected>Loading...</option>
  </select>

  <script>
    const apiBaseUrl = 'https://videos.marcosismotion.co.uk/api';

    function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Please choose a file.");

      const xhr = new XMLHttpRequest();
      const progressBar = document.getElementById("uploadProgress");
      const progressText = document.getElementById("progressText");
      const speedText = document.getElementById("speedText");
      const container = document.getElementById("progressContainer");

      const formData = new FormData();
      formData.append("file", file);

      container.style.display = "block";
      let startTime = new Date().getTime();

      xhr.upload.addEventListener("progress", function (e) {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          progressBar.value = percent;
          progressText.innerText = `${percent}%`;

          const elapsedTime = (new Date().getTime() - startTime) / 1000;
          const speedMBps = (e.loaded / (1024 * 1024)) / elapsedTime;
          speedText.innerText = `Speed: ${speedMBps.toFixed(2)} MB/s`;
        }
      });

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
          alert("âœ… Upload complete!");
          progressBar.value = 0;
          progressText.innerText = "0%";
          speedText.innerText = "Speed: 0 MB/s";
          container.style.display = "none";
          document.getElementById("fileInput").value = "";
          loadVideoList();
        }
      };

      xhr.open("POST", `${apiBaseUrl}/upload`, true);
      xhr.send(formData);
    }

    async function loadVideoList() {
  try {
    const response = await fetch(`${apiBaseUrl}/videos`);
    const videos = await response.json();
    const dropdown = document.getElementById('videoDropdown');
    dropdown.innerHTML = '<option disabled selected>Select a video</option>';
    videos.forEach(video => {
      const option = document.createElement('option');
      option.value = video;
      option.textContent = video;
      dropdown.appendChild(option);
    });

    // When user selects a video, load thumbnail
    dropdown.onchange = () => {
      const selected = dropdown.value;
      const preview = document.getElementById('videoPreview');
      preview.src = `${apiBaseUrl}/thumbnail/${encodeURIComponent(selected)}?t=${Date.now()}`; // bust cache
    };

  } catch (error) {
    const dropdown = document.getElementById('videoDropdown');
    dropdown.innerHTML = '<option>Failed to load video list.</option>';
    console.error('List error:', error);
  }
}

    loadVideoList();
  </script>
</body>
</html>
